# Alembic Migration Setup and User Manual

## Overview
Alembic is a lightweight database migration tool for managing schema changes in SQLAlchemy-based projects. This manual provides detailed instructions for setting up and using Alembic, along with examples, debugging tips, and common use cases.

---

## 1. Setting Up Alembic for Your Project

### Step 1: Install Alembic
Ensure Alembic is installed in your Python environment:
```bash
pip install alembic
```

### Step 2: Initialize Alembic
Navigate to your project directory and initialize Alembic:
```bash
alembic init migrations
```
This creates a `migrations/` directory and an `alembic.ini` configuration file.

### Step 3: Configure `alembic.ini`
Edit the `sqlalchemy.url` in `alembic.ini` to point to your database. For example:
```ini
sqlalchemy.url = sqlite:///./data/clinic_schedule.db
```
For other databases, use the appropriate connection string (e.g., PostgreSQL, MySQL).

### Step 4: Update `env.py`
Edit `migrations/env.py` to reference your SQLAlchemy metadata:
```python
from database.models import Base  # Adjust the path to your models

target_metadata = Base.metadata
```

---

## 2. Creating and Applying Migrations

### Creating a Migration
To generate a new migration file based on model changes:
```bash
alembic revision --autogenerate -m "Description of migration"
```
This creates a new file in `migrations/versions/` with autogenerated commands.

### Applying Migrations
To apply all pending migrations:
```bash
alembic upgrade head
```

### Downgrading Migrations
To revert the last applied migration:
```bash
alembic downgrade -1
```

---

## 3. Common Use Cases

### Adding a New Table
1. Add the table definition to your SQLAlchemy models.
2. Generate a migration:
   ```bash
   alembic revision --autogenerate -m "Add new table"
   ```
3. Apply the migration:
   ```bash
   alembic upgrade head
   ```

### Modifying an Existing Table
SQLite does not fully support column alterations. For unsupported operations:
1. Use `op.create_table` to define a new table with the desired schema.
2. Copy data from the old table to the new one:
   ```python
   op.execute('INSERT INTO new_table SELECT * FROM old_table')
   ```
3. Drop the old table and rename the new table.

---

## 4. Debugging

### Verify Connection
Run:
```bash
alembic current
```
Expected output:
- Displays the current migration hash.
- Confirms a working database connection.

### Common Errors
- **`ALTER TABLE` not supported**:
  SQLite does not support altering columns. Use table recreation as described above.
- **`alembic.util.messaging` errors**:
  Ensure `target_metadata` is correctly set in `env.py`.

### Manual Verification
Use `sqlite3` to check your database:
```bash
sqlite3 ./data/clinic_schedule.db
.tables
SELECT * FROM alembic_version;
```

---

## 5. Example Workflow

### Scenario: Adding a Unique Column
1. Modify your model:
   ```python
   class Example(Base):
       __tablename__ = 'example'
       id = sa.Column(sa.Integer, primary_key=True)
       unique_field = sa.Column(sa.String(50), unique=True)
   ```
2. Generate the migration:
   ```bash
   alembic revision --autogenerate -m "Add unique field"
   ```
3. Review the migration file and apply it:
   ```bash
   alembic upgrade head
   ```

### Scenario: Initializing a New Database
1. Stamp the current database state without applying migrations:
   ```bash
   alembic stamp head
   ```
2. Apply all migrations to a new database:
   ```bash
   alembic upgrade head
   ```

---

## 6. Initializing Alembic for a New User

### Step 1: Clone the Repository
Clone the project repository and set up the virtual environment:
```bash
git clone <repo_url>
cd project_directory
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Step 2: Configure Database
Ensure the database is initialized and the connection string is set in `alembic.ini`.

### Step 3: Run Migrations
Apply all existing migrations:
```bash
alembic upgrade head
```

---

## 7. References and Resources
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://www.sqlalchemy.org/)
- Common SQLite Commands:
  ```bash
  sqlite3 ./data/clinic_schedule.db
  .tables
  PRAGMA table_info('table_name');
  ```

This manual provides a comprehensive guide for setting up, using, and debugging Alembic migrations in your project. Let me know if you need further details or examples!

